terraform {
  required_providers {
    rancher2 = {
      source  = "rancher/rancher2"
      version = ">= 3.0.0"
    }
  }
}

provider "rancher2" {
  api_url   = var.rancher_url
  token_key = var.rancher_token
}

# ------------------------------------------------------------
# Enable Keycloak OIDC Auth in Rancher
# ------------------------------------------------------------
resource "rancher2_auth_config_keycloak" "keycloak" {
  enabled = true

  display_name = "Keycloak OIDC"

  # URL of your Keycloak instance
  issuer       = var.keycloak_issuer       # e.g. https://keycloak.example.com/realms/myrealm
  client_id    = var.keycloak_client_id
  client_secret = var.keycloak_client_secret

  # Rancher URL where Keycloak should redirect back
  rancher_url  = var.rancher_url

  # Rancher OIDC settings
  auth_endpoint         = "${var.keycloak_issuer}/protocol/openid-connect/auth"
  token_endpoint        = "${var.keycloak_issuer}/protocol/openid-connect/token"
  userinfo_endpoint     = "${var.keycloak_issuer}/protocol/openid-connect/userinfo"

  scopes = [
    "openid",
    "profile",
    "email",
    "groups"
  ]

  # Name of the attribute that maps to Rancher username
  user_name_field = "preferred_username"

  # Optional group mapping
  groups_field    = "groups"

  # Disable automatic user creation if you want manual control
  allowed_principal_ids = []
}
